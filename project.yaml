version: '3.0'

expectations:

  population_size: 100000

actions:

  ## # # # # # # # # # # # # # # # # # # # 
  ## DO NOT EDIT project.yaml DIRECTLY 
  ## This file is created by create-project.R 
  ## Edit and run create-project.R to update the project.yaml 
  ## # # # # # # # # # # # # # # # # # # # 
  ##   
  ## # # # # # # # # # # # # # # # # # # # 
  ## Preliminaries 
  ## # # # # # # # # # # # # # # # # # # # 

  design:
    run: r:latest analysis/design.R
    outputs:
      moderately_sensitive:
        lib: lib/design/study-dates.json

  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and process treated data 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_treated:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_treated
      --output-file output/treated/extract/input_treated.feather
    needs:
    - design
    outputs:
      highly_sensitive:
        extract: output/treated/extract/input_treated.feather

  process_treated:
    run: r:latest analysis/process_data.R treated
    needs:
    - extract_treated
    outputs:
      highly_sensitive:
        eligiblerds: output/treated/eligible/*.rds
        pfizer: output/pfizer/treated/*.rds
        moderna: output/moderna/treated/*.rds
      moderately_sensitive:
        eligiblecsv: output/treated/eligible/*.csv
        input_treated_skim: output/treated/extract/*.txt
        data_processed_skim: output/treated/process/*.txt
        data_eligible_skim: output/treated/eligible/*.txt

  ## # # # # # # # # # # # # # # # # # # # 
  ## mrna cohort 
  ## # # # # # # # # # # # # # # # # # # # 
  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and match 

  extract_controlpotential_mrna_1:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/mrna/matchround1/extract/input_controlpotential.feather
      --param cohort=mrna --param matching_round=1 --param index_date=2021-09-16
    needs:
    - design
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround1/extract/input_controlpotential.feather

  process_controlpotential_mrna_1:
    run: r:latest analysis/process_data.R potential mrna 1
    needs:
    - extract_controlpotential_mrna_1
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround1/process/*.rds
      moderately_sensitive:
        input_controlpotential_skim: output/mrna/matchround1/extract/potential/*.txt
        data_processed_skim: output/mrna/matchround1/potential/*.txt
        data_controlpotential_skim: output/mrna/matchround1/process/*.txt

  match_potential_mrna_1:
    run: r:latest analysis/matching/match_potential.R mrna 1
    needs:
    - process_treated
    - process_controlpotential_mrna_1
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround1/potential/*.rds
        csv: output/mrna/matchround1/potential/*.csv.gz

  extract_controlactual_mrna_1:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/mrna/matchround1/extract/input_controlactual.feather --param
      cohort=mrna --param matching_round=1
    needs:
    - design
    - match_potential_mrna_1
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround1/extract/input_controlactual.feather

  process_controlactual_mrna_1:
    run: r:latest analysis/process_data.R actual mrna 1
    needs:
    - process_treated
    - match_potential_mrna_1
    - extract_controlpotential_mrna_1
    - process_controlpotential_mrna_1
    - extract_controlactual_mrna_1
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround1/actual/*.rds
        csv: output/mrna/matchround1/actual/*.csv.gz
      moderately_sensitive:
        input_controlactual_skim: output/mrna/matchround1/extract/actual/*.txt
        data_actual_skim: output/mrna/matchround1/actual/*.txt

  extract_controlpotential_mrna_2:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/mrna/matchround2/extract/input_controlpotential.feather
      --param cohort=mrna --param matching_round=2 --param index_date=2021-09-30
    needs:
    - design
    - process_controlactual_mrna_1
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround2/extract/input_controlpotential.feather

  process_controlpotential_mrna_2:
    run: r:latest analysis/process_data.R potential mrna 2
    needs:
    - extract_controlpotential_mrna_2
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround2/process/*.rds
      moderately_sensitive:
        input_controlpotential_skim: output/mrna/matchround2/extract/potential/*.txt
        data_processed_skim: output/mrna/matchround2/potential/*.txt
        data_controlpotential_skim: output/mrna/matchround2/process/*.txt

  match_potential_mrna_2:
    run: r:latest analysis/matching/match_potential.R mrna 2
    needs:
    - process_treated
    - process_controlpotential_mrna_2
    - process_controlactual_mrna_1
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround2/potential/*.rds
        csv: output/mrna/matchround2/potential/*.csv.gz

  extract_controlactual_mrna_2:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/mrna/matchround2/extract/input_controlactual.feather --param
      cohort=mrna --param matching_round=2
    needs:
    - design
    - match_potential_mrna_2
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround2/extract/input_controlactual.feather

  process_controlactual_mrna_2:
    run: r:latest analysis/process_data.R actual mrna 2
    needs:
    - process_treated
    - match_potential_mrna_2
    - extract_controlpotential_mrna_2
    - process_controlpotential_mrna_2
    - extract_controlactual_mrna_2
    - process_controlactual_mrna_1
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround2/actual/*.rds
        csv: output/mrna/matchround2/actual/*.csv.gz
      moderately_sensitive:
        input_controlactual_skim: output/mrna/matchround2/extract/actual/*.txt
        data_actual_skim: output/mrna/matchround2/actual/*.txt

  extract_controlpotential_mrna_3:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/mrna/matchround3/extract/input_controlpotential.feather
      --param cohort=mrna --param matching_round=3 --param index_date=2021-10-14
    needs:
    - design
    - process_controlactual_mrna_2
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround3/extract/input_controlpotential.feather

  process_controlpotential_mrna_3:
    run: r:latest analysis/process_data.R potential mrna 3
    needs:
    - extract_controlpotential_mrna_3
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround3/process/*.rds
      moderately_sensitive:
        input_controlpotential_skim: output/mrna/matchround3/extract/potential/*.txt
        data_processed_skim: output/mrna/matchround3/potential/*.txt
        data_controlpotential_skim: output/mrna/matchround3/process/*.txt

  match_potential_mrna_3:
    run: r:latest analysis/matching/match_potential.R mrna 3
    needs:
    - process_treated
    - process_controlpotential_mrna_3
    - process_controlactual_mrna_2
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround3/potential/*.rds
        csv: output/mrna/matchround3/potential/*.csv.gz

  extract_controlactual_mrna_3:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/mrna/matchround3/extract/input_controlactual.feather --param
      cohort=mrna --param matching_round=3
    needs:
    - design
    - match_potential_mrna_3
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround3/extract/input_controlactual.feather

  process_controlactual_mrna_3:
    run: r:latest analysis/process_data.R actual mrna 3
    needs:
    - process_treated
    - match_potential_mrna_3
    - extract_controlpotential_mrna_3
    - process_controlpotential_mrna_3
    - extract_controlactual_mrna_3
    - process_controlactual_mrna_2
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround3/actual/*.rds
        csv: output/mrna/matchround3/actual/*.csv.gz
      moderately_sensitive:
        input_controlactual_skim: output/mrna/matchround3/extract/actual/*.txt
        data_actual_skim: output/mrna/matchround3/actual/*.txt

  extract_controlpotential_mrna_4:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/mrna/matchround4/extract/input_controlpotential.feather
      --param cohort=mrna --param matching_round=4 --param index_date=2021-10-28
    needs:
    - design
    - process_controlactual_mrna_3
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround4/extract/input_controlpotential.feather

  process_controlpotential_mrna_4:
    run: r:latest analysis/process_data.R potential mrna 4
    needs:
    - extract_controlpotential_mrna_4
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround4/process/*.rds
      moderately_sensitive:
        input_controlpotential_skim: output/mrna/matchround4/extract/potential/*.txt
        data_processed_skim: output/mrna/matchround4/potential/*.txt
        data_controlpotential_skim: output/mrna/matchround4/process/*.txt

  match_potential_mrna_4:
    run: r:latest analysis/matching/match_potential.R mrna 4
    needs:
    - process_treated
    - process_controlpotential_mrna_4
    - process_controlactual_mrna_3
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround4/potential/*.rds
        csv: output/mrna/matchround4/potential/*.csv.gz

  extract_controlactual_mrna_4:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/mrna/matchround4/extract/input_controlactual.feather --param
      cohort=mrna --param matching_round=4
    needs:
    - design
    - match_potential_mrna_4
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround4/extract/input_controlactual.feather

  process_controlactual_mrna_4:
    run: r:latest analysis/process_data.R actual mrna 4
    needs:
    - process_treated
    - match_potential_mrna_4
    - extract_controlpotential_mrna_4
    - process_controlpotential_mrna_4
    - extract_controlactual_mrna_4
    - process_controlactual_mrna_3
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround4/actual/*.rds
        csv: output/mrna/matchround4/actual/*.csv.gz
      moderately_sensitive:
        input_controlactual_skim: output/mrna/matchround4/extract/actual/*.txt
        data_actual_skim: output/mrna/matchround4/actual/*.txt

  extract_controlpotential_mrna_5:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/mrna/matchround5/extract/input_controlpotential.feather
      --param cohort=mrna --param matching_round=5 --param index_date=2021-11-11
    needs:
    - design
    - process_controlactual_mrna_4
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround5/extract/input_controlpotential.feather

  process_controlpotential_mrna_5:
    run: r:latest analysis/process_data.R potential mrna 5
    needs:
    - extract_controlpotential_mrna_5
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround5/process/*.rds
      moderately_sensitive:
        input_controlpotential_skim: output/mrna/matchround5/extract/potential/*.txt
        data_processed_skim: output/mrna/matchround5/potential/*.txt
        data_controlpotential_skim: output/mrna/matchround5/process/*.txt

  match_potential_mrna_5:
    run: r:latest analysis/matching/match_potential.R mrna 5
    needs:
    - process_treated
    - process_controlpotential_mrna_5
    - process_controlactual_mrna_4
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround5/potential/*.rds
        csv: output/mrna/matchround5/potential/*.csv.gz

  extract_controlactual_mrna_5:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/mrna/matchround5/extract/input_controlactual.feather --param
      cohort=mrna --param matching_round=5
    needs:
    - design
    - match_potential_mrna_5
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround5/extract/input_controlactual.feather

  process_controlactual_mrna_5:
    run: r:latest analysis/process_data.R actual mrna 5
    needs:
    - process_treated
    - match_potential_mrna_5
    - extract_controlpotential_mrna_5
    - process_controlpotential_mrna_5
    - extract_controlactual_mrna_5
    - process_controlactual_mrna_4
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround5/actual/*.rds
        csv: output/mrna/matchround5/actual/*.csv.gz
      moderately_sensitive:
        input_controlactual_skim: output/mrna/matchround5/extract/actual/*.txt
        data_actual_skim: output/mrna/matchround5/actual/*.txt

  extract_controlpotential_mrna_6:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/mrna/matchround6/extract/input_controlpotential.feather
      --param cohort=mrna --param matching_round=6 --param index_date=2021-11-25
    needs:
    - design
    - process_controlactual_mrna_5
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround6/extract/input_controlpotential.feather

  process_controlpotential_mrna_6:
    run: r:latest analysis/process_data.R potential mrna 6
    needs:
    - extract_controlpotential_mrna_6
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround6/process/*.rds
      moderately_sensitive:
        input_controlpotential_skim: output/mrna/matchround6/extract/potential/*.txt
        data_processed_skim: output/mrna/matchround6/potential/*.txt
        data_controlpotential_skim: output/mrna/matchround6/process/*.txt

  match_potential_mrna_6:
    run: r:latest analysis/matching/match_potential.R mrna 6
    needs:
    - process_treated
    - process_controlpotential_mrna_6
    - process_controlactual_mrna_5
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround6/potential/*.rds
        csv: output/mrna/matchround6/potential/*.csv.gz

  extract_controlactual_mrna_6:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/mrna/matchround6/extract/input_controlactual.feather --param
      cohort=mrna --param matching_round=6
    needs:
    - design
    - match_potential_mrna_6
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround6/extract/input_controlactual.feather

  process_controlactual_mrna_6:
    run: r:latest analysis/process_data.R actual mrna 6
    needs:
    - process_treated
    - match_potential_mrna_6
    - extract_controlpotential_mrna_6
    - process_controlpotential_mrna_6
    - extract_controlactual_mrna_6
    - process_controlactual_mrna_5
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround6/actual/*.rds
        csv: output/mrna/matchround6/actual/*.csv.gz
      moderately_sensitive:
        input_controlactual_skim: output/mrna/matchround6/extract/actual/*.txt
        data_actual_skim: output/mrna/matchround6/actual/*.txt

  extract_controlpotential_mrna_7:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/mrna/matchround7/extract/input_controlpotential.feather
      --param cohort=mrna --param matching_round=7 --param index_date=2021-12-09
    needs:
    - design
    - process_controlactual_mrna_6
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround7/extract/input_controlpotential.feather

  process_controlpotential_mrna_7:
    run: r:latest analysis/process_data.R potential mrna 7
    needs:
    - extract_controlpotential_mrna_7
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround7/process/*.rds
      moderately_sensitive:
        input_controlpotential_skim: output/mrna/matchround7/extract/potential/*.txt
        data_processed_skim: output/mrna/matchround7/potential/*.txt
        data_controlpotential_skim: output/mrna/matchround7/process/*.txt

  match_potential_mrna_7:
    run: r:latest analysis/matching/match_potential.R mrna 7
    needs:
    - process_treated
    - process_controlpotential_mrna_7
    - process_controlactual_mrna_6
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround7/potential/*.rds
        csv: output/mrna/matchround7/potential/*.csv.gz

  extract_controlactual_mrna_7:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/mrna/matchround7/extract/input_controlactual.feather --param
      cohort=mrna --param matching_round=7
    needs:
    - design
    - match_potential_mrna_7
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround7/extract/input_controlactual.feather

  process_controlactual_mrna_7:
    run: r:latest analysis/process_data.R actual mrna 7
    needs:
    - process_treated
    - match_potential_mrna_7
    - extract_controlpotential_mrna_7
    - process_controlpotential_mrna_7
    - extract_controlactual_mrna_7
    - process_controlactual_mrna_6
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround7/actual/*.rds
        csv: output/mrna/matchround7/actual/*.csv.gz
      moderately_sensitive:
        input_controlactual_skim: output/mrna/matchround7/extract/actual/*.txt
        data_actual_skim: output/mrna/matchround7/actual/*.txt

  extract_controlpotential_mrna_8:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/mrna/matchround8/extract/input_controlpotential.feather
      --param cohort=mrna --param matching_round=8 --param index_date=2021-12-23
    needs:
    - design
    - process_controlactual_mrna_7
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround8/extract/input_controlpotential.feather

  process_controlpotential_mrna_8:
    run: r:latest analysis/process_data.R potential mrna 8
    needs:
    - extract_controlpotential_mrna_8
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround8/process/*.rds
      moderately_sensitive:
        input_controlpotential_skim: output/mrna/matchround8/extract/potential/*.txt
        data_processed_skim: output/mrna/matchround8/potential/*.txt
        data_controlpotential_skim: output/mrna/matchround8/process/*.txt

  match_potential_mrna_8:
    run: r:latest analysis/matching/match_potential.R mrna 8
    needs:
    - process_treated
    - process_controlpotential_mrna_8
    - process_controlactual_mrna_7
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround8/potential/*.rds
        csv: output/mrna/matchround8/potential/*.csv.gz

  extract_controlactual_mrna_8:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/mrna/matchround8/extract/input_controlactual.feather --param
      cohort=mrna --param matching_round=8
    needs:
    - design
    - match_potential_mrna_8
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround8/extract/input_controlactual.feather

  process_controlactual_mrna_8:
    run: r:latest analysis/process_data.R actual mrna 8
    needs:
    - process_treated
    - match_potential_mrna_8
    - extract_controlpotential_mrna_8
    - process_controlpotential_mrna_8
    - extract_controlactual_mrna_8
    - process_controlactual_mrna_7
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround8/actual/*.rds
        csv: output/mrna/matchround8/actual/*.csv.gz
      moderately_sensitive:
        input_controlactual_skim: output/mrna/matchround8/extract/actual/*.txt
        data_actual_skim: output/mrna/matchround8/actual/*.txt

  extract_controlpotential_mrna_9:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/mrna/matchround9/extract/input_controlpotential.feather
      --param cohort=mrna --param matching_round=9 --param index_date=2022-01-06
    needs:
    - design
    - process_controlactual_mrna_8
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround9/extract/input_controlpotential.feather

  process_controlpotential_mrna_9:
    run: r:latest analysis/process_data.R potential mrna 9
    needs:
    - extract_controlpotential_mrna_9
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround9/process/*.rds
      moderately_sensitive:
        input_controlpotential_skim: output/mrna/matchround9/extract/potential/*.txt
        data_processed_skim: output/mrna/matchround9/potential/*.txt
        data_controlpotential_skim: output/mrna/matchround9/process/*.txt

  match_potential_mrna_9:
    run: r:latest analysis/matching/match_potential.R mrna 9
    needs:
    - process_treated
    - process_controlpotential_mrna_9
    - process_controlactual_mrna_8
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround9/potential/*.rds
        csv: output/mrna/matchround9/potential/*.csv.gz

  extract_controlactual_mrna_9:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/mrna/matchround9/extract/input_controlactual.feather --param
      cohort=mrna --param matching_round=9
    needs:
    - design
    - match_potential_mrna_9
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround9/extract/input_controlactual.feather

  process_controlactual_mrna_9:
    run: r:latest analysis/process_data.R actual mrna 9
    needs:
    - process_treated
    - match_potential_mrna_9
    - extract_controlpotential_mrna_9
    - process_controlpotential_mrna_9
    - extract_controlactual_mrna_9
    - process_controlactual_mrna_8
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround9/actual/*.rds
        csv: output/mrna/matchround9/actual/*.csv.gz
      moderately_sensitive:
        input_controlactual_skim: output/mrna/matchround9/extract/actual/*.txt
        data_actual_skim: output/mrna/matchround9/actual/*.txt

  extract_controlpotential_mrna_10:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/mrna/matchround10/extract/input_controlpotential.feather
      --param cohort=mrna --param matching_round=10 --param index_date=2022-01-20
    needs:
    - design
    - process_controlactual_mrna_9
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround10/extract/input_controlpotential.feather

  process_controlpotential_mrna_10:
    run: r:latest analysis/process_data.R potential mrna 10
    needs:
    - extract_controlpotential_mrna_10
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround10/process/*.rds
      moderately_sensitive:
        input_controlpotential_skim: output/mrna/matchround10/extract/potential/*.txt
        data_processed_skim: output/mrna/matchround10/potential/*.txt
        data_controlpotential_skim: output/mrna/matchround10/process/*.txt

  match_potential_mrna_10:
    run: r:latest analysis/matching/match_potential.R mrna 10
    needs:
    - process_treated
    - process_controlpotential_mrna_10
    - process_controlactual_mrna_9
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround10/potential/*.rds
        csv: output/mrna/matchround10/potential/*.csv.gz

  extract_controlactual_mrna_10:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/mrna/matchround10/extract/input_controlactual.feather --param
      cohort=mrna --param matching_round=10
    needs:
    - design
    - match_potential_mrna_10
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround10/extract/input_controlactual.feather

  process_controlactual_mrna_10:
    run: r:latest analysis/process_data.R actual mrna 10
    needs:
    - process_treated
    - match_potential_mrna_10
    - extract_controlpotential_mrna_10
    - process_controlpotential_mrna_10
    - extract_controlactual_mrna_10
    - process_controlactual_mrna_9
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround10/actual/*.rds
        csv: output/mrna/matchround10/actual/*.csv.gz
      moderately_sensitive:
        input_controlactual_skim: output/mrna/matchround10/extract/actual/*.txt
        data_actual_skim: output/mrna/matchround10/actual/*.txt

  extract_controlpotential_mrna_11:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/mrna/matchround11/extract/input_controlpotential.feather
      --param cohort=mrna --param matching_round=11 --param index_date=2022-02-03
    needs:
    - design
    - process_controlactual_mrna_10
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround11/extract/input_controlpotential.feather

  process_controlpotential_mrna_11:
    run: r:latest analysis/process_data.R potential mrna 11
    needs:
    - extract_controlpotential_mrna_11
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround11/process/*.rds
      moderately_sensitive:
        input_controlpotential_skim: output/mrna/matchround11/extract/potential/*.txt
        data_processed_skim: output/mrna/matchround11/potential/*.txt
        data_controlpotential_skim: output/mrna/matchround11/process/*.txt

  match_potential_mrna_11:
    run: r:latest analysis/matching/match_potential.R mrna 11
    needs:
    - process_treated
    - process_controlpotential_mrna_11
    - process_controlactual_mrna_10
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround11/potential/*.rds
        csv: output/mrna/matchround11/potential/*.csv.gz

  extract_controlactual_mrna_11:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/mrna/matchround11/extract/input_controlactual.feather --param
      cohort=mrna --param matching_round=11
    needs:
    - design
    - match_potential_mrna_11
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround11/extract/input_controlactual.feather

  process_controlactual_mrna_11:
    run: r:latest analysis/process_data.R actual mrna 11
    needs:
    - process_treated
    - match_potential_mrna_11
    - extract_controlpotential_mrna_11
    - process_controlpotential_mrna_11
    - extract_controlactual_mrna_11
    - process_controlactual_mrna_10
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround11/actual/*.rds
        csv: output/mrna/matchround11/actual/*.csv.gz
      moderately_sensitive:
        input_controlactual_skim: output/mrna/matchround11/extract/actual/*.txt
        data_actual_skim: output/mrna/matchround11/actual/*.txt

  extract_controlpotential_mrna_12:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/mrna/matchround12/extract/input_controlpotential.feather
      --param cohort=mrna --param matching_round=12 --param index_date=2022-02-17
    needs:
    - design
    - process_controlactual_mrna_11
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround12/extract/input_controlpotential.feather

  process_controlpotential_mrna_12:
    run: r:latest analysis/process_data.R potential mrna 12
    needs:
    - extract_controlpotential_mrna_12
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround12/process/*.rds
      moderately_sensitive:
        input_controlpotential_skim: output/mrna/matchround12/extract/potential/*.txt
        data_processed_skim: output/mrna/matchround12/potential/*.txt
        data_controlpotential_skim: output/mrna/matchround12/process/*.txt

  match_potential_mrna_12:
    run: r:latest analysis/matching/match_potential.R mrna 12
    needs:
    - process_treated
    - process_controlpotential_mrna_12
    - process_controlactual_mrna_11
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround12/potential/*.rds
        csv: output/mrna/matchround12/potential/*.csv.gz

  extract_controlactual_mrna_12:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/mrna/matchround12/extract/input_controlactual.feather --param
      cohort=mrna --param matching_round=12
    needs:
    - design
    - match_potential_mrna_12
    outputs:
      highly_sensitive:
        cohort: output/mrna/matchround12/extract/input_controlactual.feather

  process_controlactual_mrna_12:
    run: r:latest analysis/process_data.R actual mrna 12
    needs:
    - process_treated
    - match_potential_mrna_12
    - extract_controlpotential_mrna_12
    - process_controlpotential_mrna_12
    - extract_controlactual_mrna_12
    - process_controlactual_mrna_11
    outputs:
      highly_sensitive:
        rds: output/mrna/matchround12/actual/*.rds
        csv: output/mrna/matchround12/actual/*.csv.gz
      moderately_sensitive:
        input_controlactual_skim: output/mrna/matchround12/extract/actual/*.txt
        data_actual_skim: output/mrna/matchround12/actual/*.txt

  extract_controlfinal_mrna:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlfinal
      --output-file output/mrna/extract/input_controlfinal.feather --param cohort=mrna
      --param n_matching_rounds=12
    needs:
    - design
    - process_controlactual_mrna_12
    outputs:
      highly_sensitive:
        extract: output/mrna/extract/input_controlfinal.feather

  dummydata_controlfinal_mrna:
    run: r:latest analysis/dummy/dummydata_controlfinal.R mrna
    needs:
    - process_controlactual_mrna_1
    - process_controlactual_mrna_2
    - process_controlactual_mrna_3
    - process_controlactual_mrna_4
    - process_controlactual_mrna_5
    - process_controlactual_mrna_6
    - process_controlactual_mrna_7
    - process_controlactual_mrna_8
    - process_controlactual_mrna_9
    - process_controlactual_mrna_10
    - process_controlactual_mrna_11
    - process_controlactual_mrna_12
    outputs:
      highly_sensitive:
        dummydata_controlfinal: output/mrna/dummydata/dummy_control_final.feather

  process_controlfinal_mrna:
    run: r:latest analysis/process_data.R final mrna
    needs:
    - process_controlactual_mrna_1
    - process_controlactual_mrna_2
    - process_controlactual_mrna_3
    - process_controlactual_mrna_4
    - process_controlactual_mrna_5
    - process_controlactual_mrna_6
    - process_controlactual_mrna_7
    - process_controlactual_mrna_8
    - process_controlactual_mrna_9
    - process_controlactual_mrna_10
    - process_controlactual_mrna_11
    - process_controlactual_mrna_12
    - extract_controlfinal_mrna
    - process_treated
    - dummydata_controlfinal_mrna
    outputs:
      highly_sensitive:
        extract: output/mrna/match/*.rds
      moderately_sensitive:
        input_controlfinal_skim: output/mrna/extract/*.txt
        data_matched_skim: output/mrna/match/*.txt

  table1_mrna:
    run: r:latest analysis/matching/table1.R mrna
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        csv: output/mrna/table1/*.csv
        png: output/mrna/table1/*.png

  cinc_dose4_mrna:
    run: r:latest analysis/model/cinc_dose4.R mrna
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        csv: output/mrna/models/cinc_dose4/*.csv
        png: output/mrna/models/cinc_dose4/*.png

  ## # # # # # # # # # # # # # # # # # # # 
  ## Model 
  ## # # # # # # # # # # # # # # # # # # # 
  ## cohort: mrna; subgroup: all 
  ## # # # # # # # # # # # # # # # # # # # 

  km_mrna_all_postest:
    run: r:latest analysis/model/km.R mrna all postest
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/all/postest/*.rds
        png: output/mrna/models/km/all/postest/*.png

  km_mrna_all_covidadmitted:
    run: r:latest analysis/model/km.R mrna all covidadmitted
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/all/covidadmitted/*.rds
        png: output/mrna/models/km/all/covidadmitted/*.png

  km_mrna_all_covidcritcareordeath:
    run: r:latest analysis/model/km.R mrna all covidcritcareordeath
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/all/covidcritcareordeath/*.rds
        png: output/mrna/models/km/all/covidcritcareordeath/*.png

  km_mrna_all_emergency:
    run: r:latest analysis/model/km.R mrna all emergency
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/all/emergency/*.rds
        png: output/mrna/models/km/all/emergency/*.png

  km_mrna_all_covidemergency:
    run: r:latest analysis/model/km.R mrna all covidemergency
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/all/covidemergency/*.rds
        png: output/mrna/models/km/all/covidemergency/*.png

  km_mrna_all_noncoviddeath:
    run: r:latest analysis/model/km.R mrna all noncoviddeath
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/all/noncoviddeath/*.rds
        png: output/mrna/models/km/all/noncoviddeath/*.png

  ## # # # # # # # # # # # # # # # # # # # 
  ## cohort: mrna; subgroup: vax3_type 
  ## # # # # # # # # # # # # # # # # # # # 

  km_mrna_vax3_type_postest:
    run: r:latest analysis/model/km.R mrna vax3_type postest
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/vax3_type/postest/*.rds
        png: output/mrna/models/km/vax3_type/postest/*.png

  km_mrna_vax3_type_covidadmitted:
    run: r:latest analysis/model/km.R mrna vax3_type covidadmitted
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/vax3_type/covidadmitted/*.rds
        png: output/mrna/models/km/vax3_type/covidadmitted/*.png

  km_mrna_vax3_type_covidcritcareordeath:
    run: r:latest analysis/model/km.R mrna vax3_type covidcritcareordeath
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/vax3_type/covidcritcareordeath/*.rds
        png: output/mrna/models/km/vax3_type/covidcritcareordeath/*.png

  km_mrna_vax3_type_emergency:
    run: r:latest analysis/model/km.R mrna vax3_type emergency
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/vax3_type/emergency/*.rds
        png: output/mrna/models/km/vax3_type/emergency/*.png

  km_mrna_vax3_type_covidemergency:
    run: r:latest analysis/model/km.R mrna vax3_type covidemergency
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/vax3_type/covidemergency/*.rds
        png: output/mrna/models/km/vax3_type/covidemergency/*.png

  km_mrna_vax3_type_noncoviddeath:
    run: r:latest analysis/model/km.R mrna vax3_type noncoviddeath
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/vax3_type/noncoviddeath/*.rds
        png: output/mrna/models/km/vax3_type/noncoviddeath/*.png

  ## # # # # # # # # # # # # # # # # # # # 
  ## cohort: mrna; subgroup: prior_covid_infection 
  ## # # # # # # # # # # # # # # # # # # # 

  km_mrna_prior_covid_infection_postest:
    run: r:latest analysis/model/km.R mrna prior_covid_infection postest
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/prior_covid_infection/postest/*.rds
        png: output/mrna/models/km/prior_covid_infection/postest/*.png

  km_mrna_prior_covid_infection_covidadmitted:
    run: r:latest analysis/model/km.R mrna prior_covid_infection covidadmitted
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/prior_covid_infection/covidadmitted/*.rds
        png: output/mrna/models/km/prior_covid_infection/covidadmitted/*.png

  km_mrna_prior_covid_infection_covidcritcareordeath:
    run: r:latest analysis/model/km.R mrna prior_covid_infection covidcritcareordeath
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/prior_covid_infection/covidcritcareordeath/*.rds
        png: output/mrna/models/km/prior_covid_infection/covidcritcareordeath/*.png

  km_mrna_prior_covid_infection_emergency:
    run: r:latest analysis/model/km.R mrna prior_covid_infection emergency
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/prior_covid_infection/emergency/*.rds
        png: output/mrna/models/km/prior_covid_infection/emergency/*.png

  km_mrna_prior_covid_infection_covidemergency:
    run: r:latest analysis/model/km.R mrna prior_covid_infection covidemergency
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/prior_covid_infection/covidemergency/*.rds
        png: output/mrna/models/km/prior_covid_infection/covidemergency/*.png

  km_mrna_prior_covid_infection_noncoviddeath:
    run: r:latest analysis/model/km.R mrna prior_covid_infection noncoviddeath
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/prior_covid_infection/noncoviddeath/*.rds
        png: output/mrna/models/km/prior_covid_infection/noncoviddeath/*.png

  ## # # # # # # # # # # # # # # # # # # # 
  ## cohort: mrna; subgroup: vax12_type 
  ## # # # # # # # # # # # # # # # # # # # 

  km_mrna_vax12_type_postest:
    run: r:latest analysis/model/km.R mrna vax12_type postest
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/vax12_type/postest/*.rds
        png: output/mrna/models/km/vax12_type/postest/*.png

  km_mrna_vax12_type_covidadmitted:
    run: r:latest analysis/model/km.R mrna vax12_type covidadmitted
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/vax12_type/covidadmitted/*.rds
        png: output/mrna/models/km/vax12_type/covidadmitted/*.png

  km_mrna_vax12_type_covidcritcareordeath:
    run: r:latest analysis/model/km.R mrna vax12_type covidcritcareordeath
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/vax12_type/covidcritcareordeath/*.rds
        png: output/mrna/models/km/vax12_type/covidcritcareordeath/*.png

  km_mrna_vax12_type_emergency:
    run: r:latest analysis/model/km.R mrna vax12_type emergency
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/vax12_type/emergency/*.rds
        png: output/mrna/models/km/vax12_type/emergency/*.png

  km_mrna_vax12_type_covidemergency:
    run: r:latest analysis/model/km.R mrna vax12_type covidemergency
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/vax12_type/covidemergency/*.rds
        png: output/mrna/models/km/vax12_type/covidemergency/*.png

  km_mrna_vax12_type_noncoviddeath:
    run: r:latest analysis/model/km.R mrna vax12_type noncoviddeath
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/vax12_type/noncoviddeath/*.rds
        png: output/mrna/models/km/vax12_type/noncoviddeath/*.png

  ## # # # # # # # # # # # # # # # # # # # 
  ## cohort: mrna; subgroup: ageband 
  ## # # # # # # # # # # # # # # # # # # # 

  km_mrna_ageband_postest:
    run: r:latest analysis/model/km.R mrna ageband postest
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/ageband/postest/*.rds
        png: output/mrna/models/km/ageband/postest/*.png

  km_mrna_ageband_covidadmitted:
    run: r:latest analysis/model/km.R mrna ageband covidadmitted
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/ageband/covidadmitted/*.rds
        png: output/mrna/models/km/ageband/covidadmitted/*.png

  km_mrna_ageband_covidcritcareordeath:
    run: r:latest analysis/model/km.R mrna ageband covidcritcareordeath
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/ageband/covidcritcareordeath/*.rds
        png: output/mrna/models/km/ageband/covidcritcareordeath/*.png

  km_mrna_ageband_emergency:
    run: r:latest analysis/model/km.R mrna ageband emergency
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/ageband/emergency/*.rds
        png: output/mrna/models/km/ageband/emergency/*.png

  km_mrna_ageband_covidemergency:
    run: r:latest analysis/model/km.R mrna ageband covidemergency
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/ageband/covidemergency/*.rds
        png: output/mrna/models/km/ageband/covidemergency/*.png

  km_mrna_ageband_noncoviddeath:
    run: r:latest analysis/model/km.R mrna ageband noncoviddeath
    needs:
    - process_controlfinal_mrna
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/ageband/noncoviddeath/*.rds
        png: output/mrna/models/km/ageband/noncoviddeath/*.png

  ## # # # # # # # # # # # # # # # # # # # 
  ## combine all outputs for mrna cohort 
  ## # # # # # # # # # # # # # # # # # # # 

  combine_km_mrna:
    run: r:latest analysis/model/km_combine.R mrna
    needs:
    - km_mrna_all_postest
    - km_mrna_all_covidadmitted
    - km_mrna_all_covidcritcareordeath
    - km_mrna_all_emergency
    - km_mrna_all_covidemergency
    - km_mrna_all_noncoviddeath
    - km_mrna_vax3_type_postest
    - km_mrna_vax3_type_covidadmitted
    - km_mrna_vax3_type_covidcritcareordeath
    - km_mrna_vax3_type_emergency
    - km_mrna_vax3_type_covidemergency
    - km_mrna_vax3_type_noncoviddeath
    - km_mrna_prior_covid_infection_postest
    - km_mrna_prior_covid_infection_covidadmitted
    - km_mrna_prior_covid_infection_covidcritcareordeath
    - km_mrna_prior_covid_infection_emergency
    - km_mrna_prior_covid_infection_covidemergency
    - km_mrna_prior_covid_infection_noncoviddeath
    - km_mrna_vax12_type_postest
    - km_mrna_vax12_type_covidadmitted
    - km_mrna_vax12_type_covidcritcareordeath
    - km_mrna_vax12_type_emergency
    - km_mrna_vax12_type_covidemergency
    - km_mrna_vax12_type_noncoviddeath
    - km_mrna_ageband_postest
    - km_mrna_ageband_covidadmitted
    - km_mrna_ageband_covidcritcareordeath
    - km_mrna_ageband_emergency
    - km_mrna_ageband_covidemergency
    - km_mrna_ageband_noncoviddeath
    outputs:
      moderately_sensitive:
        rds: output/mrna/models/km/combined/*.csv
        png: output/mrna/models/km/combined/*.png

  ## #### End #### 

