version: '3.0'

expectations:

  population_size: 100000

actions:

  ## # # # # # # # # # # # # # # # # # # # 
  ## DO NOT EDIT project.yaml DIRECTLY 
  ## This file is created by create-project.R 
  ## Edit and run create-project.R to update the project.yaml 
  ## # # # # # # # # # # # # # # # # # # # 
  ##   
  ## # # # # # # # # # # # # # # # # # # # 
  ## Preliminaries 
  ## # # # # # # # # # # # # # # # # # # # 

  design:
    run: r:latest analysis/design.R
    outputs:
      moderately_sensitive:
        lib: lib/design/study-dates.json

  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and process treated data 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_treated:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_treated
      --output-file output/treated/extract/input_treated.feather
    needs:
    - design
    outputs:
      highly_sensitive:
        extract: output/treated/extract/input_treated.feather

  process_treated:
    run: r:latest analysis/process_data.R treated
    needs:
    - extract_treated
    outputs:
      highly_sensitive:
        eligible: output/treated/eligible/*.rds
        pfizer: output/pfizer/treated/*.rds
        moderna: output/moderna/treated/*.rds

  ## # # # # # # # # # # # # # # # # # # # 
  ## Pfizer cohort 
  ## # # # # # # # # # # # # # # # # # # # 
  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and match 

  extract_controlpotential_pfizer_1:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/pfizer/matchround1/extract/input_controlpotential.feather
      --param cohort=pfizer --param matching_round=1 --param index_date=2021-09-16
    needs:
    - design
    outputs:
      highly_sensitive:
        cohort: output/pfizer/matchround1/extract/input_controlpotential.feather

  process_controlpotential_pfizer_1:
    run: r:latest analysis/process_data.R control pfizer 1
    needs:
    - extract_controlpotential_pfizer_1
    outputs:
      highly_sensitive:
        rds: output/pfizer/matchround1/process/*.rds

  
  ## #### End #### 

